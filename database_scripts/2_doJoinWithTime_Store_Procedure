USE `colfusion`;
DROP procedure IF EXISTS `doJoinWithTime`;

DELIMITER $$
USE `colfusion`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `doJoinWithTime`(IN `sidParam` VARCHAR(200), IN `tableNameParam` VARCHAR(200))
    READS SQL DATA
BEGIN

	SET @sid := TRIM(BOTH ',' FROM sidParam);
	SET @tableName := TRIM(BOTH ',' FROM tableNameParam);

	SET @sql = CONCAT('drop temporary table if exists resultDoJoin');
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;

	IF @sid <> "" THEN
			
			SET @sql = NULL;

			SELECT
			  GROUP_CONCAT(DISTINCT
				CONCAT(
				  'MAX(IF(dname = ''',
				  TRIM(dname),
				  ''', value, NULL)) AS `',
				  TRIM(dname),'`'
				)
			  ) INTO @sql
			FROM
			  colfusion_temporary, colfusion_columnTableInfo
			where 
				colfusion_temporary.cid = colfusion_columnTableInfo.cid
				and colfusion_columnTableInfo.tableName = @tableName 
				and sid = @sid;
				
			SET @sql = CONCAT('CREATE TEMPORARY TABLE resultDoJoin SELECT * FROM (SELECT rownum, ', @sql, ' FROM colfusion_temporary, colfusion_columnTableInfo where colfusion_temporary.cid = colfusion_columnTableInfo.cid and colfusion_columnTableInfo.tableName = \'', @tableName, '\' and sid = ', @sid,' GROUP BY rownum) as t1' );

			PREPARE stmt FROM @sql;
			EXECUTE stmt;
			DEALLOCATE PREPARE stmt;

	END IF;

END$$

DELIMITER ;


