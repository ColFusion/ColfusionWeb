USE `colfusion`;
DROP procedure IF EXISTS `doJoinWithTime`;

DELIMITER $$
USE `colfusion`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `doJoinWithTime`(IN sidParam varchar(200), IN tableNameParam varchar(200))
    READS SQL DATA
BEGIN

	SET @sid := TRIM(BOTH ',' FROM sidParam);
	SET @tableName := TRIM(BOTH ',' FROM tableNameParam);
	
	SET @i := 1;

	
	SET @joinTableIndex := 0;
	
	SET @sql = CONCAT('drop temporary table if exists resultDoJoin');
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;

	IF @sid <> "" THEN

			SET @sql = CONCAT('drop temporary table if exists tmpTable', @i);
			PREPARE stmt FROM @sql;
			EXECUTE stmt;
			DEALLOCATE PREPARE stmt;

			SET @sql = NULL;

			SELECT
			  GROUP_CONCAT(DISTINCT
				CONCAT(
				  'MAX(IF(dname = ''',
				  TRIM(dname),
				  ''', value, NULL)) AS `',
				  TRIM(dname),'`'
				)
			  ) INTO @sql
			FROM
			  colfusion_temporary, colfusion_columnTableInfo
			where 
				colfusion_temporary.cid = colfusion_columnTableInfo.cid
				and colfusion_columnTableInfo.tableName = @tableName 
				and sid = @sid;
				
			SET @sql = CONCAT('CREATE TEMPORARY TABLE resultDoJoin SELECT * FROM (SELECT rownum, ', @sql, ' FROM colfusion_temporary, colfusion_columnTableInfo where colfusion_temporary.cid = colfusion_columnTableInfo.cid and colfusion_columnTableInfo.tableName = \'', @tableName, '\' and sid = ', @sid,' GROUP BY rownum) as t1 natural join (select distinct Spd, Drd, Location, AggrType, Start, End, rownum from colfusion_temporary, colfusion_columnTableInfo where colfusion_temporary.cid = colfusion_columnTableInfo.cid and colfusion_columnTableInfo.tableName = \'', @tableName, '\' and sid = ', @sid, ') as t2');

			PREPARE stmt FROM @sql;
			EXECUTE stmt;
			DEALLOCATE PREPARE stmt;

	END IF;

END$$

DELIMITER ;


